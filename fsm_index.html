<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<title>Finite State Machine</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="/ui/css/bootstrap.css" rel="stylesheet" type="text/css" />
	<link href="/ui/css/bootstrap-responsive.css" rel="stylesheet" type="text/css" />
	<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
	<script type="text/javascript" src="/ui/js/jquery.cookie.js"></script>

	<link rel="icon" href="/ui/images/kids-favicon<?php echo '-blue'; ?>.png" type="image/png" />
	<link rel="apple-touch-icon" href="/ui/favicon/kids/kids-favicon.png" />
	<link href='http://fonts.googleapis.com/css?family=Fredoka+One' rel='stylesheet' type='text/css' />
	<link href='http://fonts.googleapis.com/css?family=Quicksand' rel='stylesheet' type='text/css'>

	<script src='https://cdn.firebase.com/js/client/1.0.15/firebase.js'></script>
	<style type="text/css">
	.panel {
		padding:20px;
		background-color:rgba(0,255,0,.5);
		-moz-border-radius: 15px;
		border-radius: 15px;
		min-height:400px;
	}
	.logotype {
		font-family: 'Quicksand', sans-serif;
		font-weight: 400;
		font-size: 64px;
		letter-spacing:-6px;
		line-height:48px;
	}
	.boid-row {
		width: 100%;
	}
	.boid-col {
		padding: 0px 6px;
		float: left;
	}
	.boid-name {
		float: left;
		width: 150px;
		overflow: hidden;
	}
	.gender {
		float:left;
		width: 12px;
		height: 12px;
	}
	.gender-male {
		float:left;
		color: white;
		background-color: blue;
	}
	.gender-female {
		float:left;
		color: black;
		background-color: pink;
	}
	.alive {
		float: left;
		width: 12px;
		height: 12px;
		background: green;
	}
	.dead {
		float: left;
		width: 12px;
		height: 12px;
		background: black;
	}
	</style>
	<script type="text/javascript">
	function fsm() {
		this.activeState = undefined;

		this.setState = function(state) {
			this.activeState = state;
		};
		this.update = function(state) {
			if(this.activeState != undefined) {
				this.activeState();
			}
		};
	}
	function ant() {
		this.position = {x:0, y:0};
		this.lead = {x:100, y:200};
		this.velocity = [-1, -1];
		this.brain = new fsm();

		this.findLeaf = function(state) {
			console.log("findLeaf");
			// Move the ant towards the leaf.
			var velocityx = this.leaf.x - this.position.x;
			var velocityy = this.leaf.y - this.position.y;

			if (distance(Game.instance.leaf, this) <= 10) {
				// The ant is extremelly close to the leaf, it's time
				// to go home.
				this.brain.setState(goHome);
			}

			if (distance(Game.mouse, this) <= MOUSE_THREAT_RADIUS) {
				// Mouse cursor is threatening us. Let's run away!
				// It will make the brain start calling runAway() from
				// now on.
				this.brain.setState(runAway);
			}
		};
		this.goHome = function(state) {
		};
		this.runAway = function(state) {
		};
		this.update = function(state) {
			this.brain.update();
			this.moveBasedOnVelocity();
		};

		// Initialize
		this.brain.setState(this.findLeaf);
	}
	function chromosome(type) {
		this.type = type;
		this.genes = {};
		this.addGene = function(name, gene) {
			this.genes[name] = gene;
		};
		this.getGenes = function() {
			return this.genes;
		}
		this.addInputs = function() {
			for(var i in this.genes) {
				$("<div>"+i +"<input name='"+i+"' value='"+this.genes[i]+"' /></div>").appendTo("#txtMessage");
			}
		}
	}
	var chromosomes = {};
	$(document).ready(function() {
		var myAnt = new ant();
		$("<div>Hello</div>").appendTo("#txtMessage");
		chromosomes['looks'] = new chromosome('looks');
		chromosomes['looks'].addGene('EyesBrownBlue', 'Aa');
		chromosomes['looks'].addGene('HairBrownBlond', 'AA');
		chromosomes['speed'] = new chromosome('speed');
		chromosomes['personality'] = new chromosome('personality');
		console.log(chromosomes);
		chromosomes['looks'].addInputs();
	});

	</script>
</head>
<body>
	<div class="container-fluid" style="min-height:800px;">
		<div class="row-fluid" style="min-height:400px;">
			<div class="span9">
				<h1>FSM</h1>
				<div id="noids" style="display:relative;"></div>
			</div>
			<div class="span2">
				<h1>Edit</h1>
				<form>
					<select name="chromosome">
						<option>chromosomesA</option>
						<option>chromosomesB</option>
					<input name="" />
				</form>
				<table class="table" id="observer">
				</table>
			</div>
			<div class="span1">
				<h1>Doctor</h1>
				<div id="txtMessage"></div>
			</div>
		</div>
	</div>
	<div id='messagesDiv'></div>
	<input type='text' id='nameInput' placeholder='Name'>
	<input type='text' id='messageInput' placeholder='Message'>
	<button class="btn" id="addCreature">Add Creature</button>
	<script>
	function getLinuxTime() {
		return Math.round((new Date()).getTime() / 1000);
	}
	Math.nrand = function(center, width) {
		var x1, x2, rad, y1;
		do {
			x1 = 2 * this.random() - 1;
			x2 = 2 * this.random() - 1;
			rad = x1 * x1 + x2 * x2;
		} while(rad >= 1 || rad == 0);
		var c = this.sqrt(-2 * Math.log(rad) / rad);
		return ((x1 * c) * (width/2)) + center;
	};
	var myDataRef = new Firebase('https://blinding-fire-4882.firebaseio.com/');
	var creaturesRef = myDataRef.child("creatures2");
	if(false) {
		creaturesRef.set({
			c1: {
				name: "Adam",
				gender: "m",
				alive: 1,
				birthTime: getLinuxTime(),
				temperature: parseInt(Math.nrand(75, 5)),
				chromosomes: {
					looks: {
						EyesBrownBlue: "Aa",
						HairBrownBlond: "AA",
					},
					speed: {},
					personality: {}
				}
			},
			c2: {
				name: "Eve",
				gender: "f",
				alive: 1,
				birthTime: getLinuxTime(),
				temperature: parseInt(Math.nrand(75, 5)),
				chromosomes: {
					looks: {
						EyesBrownBlue: "aa",
						HairBrownBlond: "aA",
					},
					speed: {},
					personality: {}
				}
			}
		});
	}
	/*
	$('#messageInput').keypress(function (e) {
		if (e.keyCode == 13) {
			var name = $('#nameInput').val();
			var text = $('#messageInput').val();
			myDataRef.push({name: name, text: text});
			$('#messageInput').val('');
		}
	});
	*/
	$('#addCreature').click(function (e) {
		if(false) {
			creaturesRef.update({
				c3: {
					name: "Harry",
					gender: "m",
					alive: 1,
					birthTime: getLinuxTime(),
					temperature: parseInt(Math.nrand(75, 5)),
					chromosomes: {
						looks: {
							EyesBrownBlue: "AA",
							HairBrownBlond: "AA",
						},
						speed: {},
						personality: {}
					}
				},
			});
		} else {
			creaturesRef.push(
				{
					name: "Pam",
					gender: "f",
					alive: 1,
					birthTime: getLinuxTime(),
					temperature: parseInt(Math.nrand(75, 5)),
					chromosomes: {
						looks: {
							EyesBrownBlue: "AA",
							HairBrownBlond: "AA",
						},
						speed: {},
						personality: {}
					}
				}
			);

		}

	});
	function createBoid(mother, father) {
		var gender = 10*Math.random() > 4 ? 'm' : 'f';
		var temperature = parseInt(Math.nrand(75, 5));
		var age = getLinuxTime();
		var deathAge = age + parseInt(3600*Math.random());
		var name = (gender=='m') ? "Sam"+temperature : "Pam"+temperature;
		creaturesRef.push(
			{
				name: name,
				gender: gender,
				alive: 1,
				deathAge: deathAge,
				birthTime: age,
				temperature: temperature,
				mother: mother,
				father: father,
				chromosomes: {
					looks: {
						EyesBrownBlue: "AA",
						HairBrownBlond: "AA",
					},
					speed: {},
					personality: {}
				}
			}
		);
		console.log("Added "+name);
	}
	function idleBoids() {
		//console.log("Idle");
		var male = false;
		var female = false;
		if(Object.keys(document.boids).length < 2) {
			//console.log("Create init");
			for(var i=0;i<10;i++) {
				createBoid(male, female);
			}
		}
		for(var i in document.boids) {
			if(document.boids[i].gender == 'm') {
				male = i;
			} else {
				female = i;
			}
			if(document.breed && male && female && (100*Math.random() < 5)) {
				createBoid(male, female);
				male = false;
				female = false;
			}
		}
	}
	$(document).ready(function() {
		document.boids = {};
		setInterval(idleBoids, 1000);
	});

	creaturesRef.on('child_added', function(snapshot) {
		var boid = snapshot.val();
		if(getLinuxTime() > boid.deathAge) {
			return;
		}
		document.boids[snapshot.name()] = snapshot.val();

		//displayChatMessage(message.name, message.birthTime);
		var out = '<div class="boid-row" id="'+snapshot.name()+'">';
		out += '<div class="boid-col boid-name">'+boid.name+'</div>';
		if(boid.gender == 'm') {
			out += "<div class='boid-col gender gender-male'>M</div>";
		} else {
			out += "<div class='boid-col gender gender-female'>F</div>";
		}
		out += "<div class='boid-col'>"+parseInt((boid.deathAge-boid.birthTime) / 60)+" minutes</div>";
		out += "<div class='boid-col'>"+boid.temperature+" &deg;</div>";
		out += "<div class='boid-col'>"+boid.father+" </div>";
		out += "<div class='boid-col'>"+boid.mother+"</div>";
		var live = 'alive';
		if(getLinuxTime() > boid.deathAge) {
			live = 'dead';
		}
		out += "<div class='boid-col "+live+"'>"+"</div>";
		out += '</div><div style="clear:both;"></div>';
		$(out).appendTo($('#noids'));
		$("#txtMessage").text($('#noids').children('.boid-row').length + " boids");
	});
	function displayChatMessage(name, text) {
		$('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#noids'));
		$('#noids')[0].scrollTop = $('#noids')[0].scrollHeight;
	};
	</script>
      </body>
</html>

